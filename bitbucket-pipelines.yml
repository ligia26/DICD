image: atlassian/default-image:4

pipelines:
  branches:
    "**":
      - step:
          name: Upload to Ubuntu server
          script:
            - apt-get update && apt-get install -y openssh-client rsync

            # Load SSH Key
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

            # Ensure server path exists
            - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "mkdir -p /var/www/new && echo Connected OK"

            # âœ… Correct rsync wrapped to avoid Bitbucket breaking command
            - >
              rsync -avz --delete
              --exclude='.env'
              --exclude='.git'
              --exclude='.gitignore'
              --exclude='*.log'
              --exclude='*.sql'
              --exclude='*.zip'
              --exclude='*.tar'
              --exclude='*.gz'
              --exclude='node_modules/'
              --exclude='vendor/'
              --exclude='storage/'
              -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
              ./ $SERVER_USER@$SERVER_IP:/var/www/new
