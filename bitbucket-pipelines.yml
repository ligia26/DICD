image: atlassian/default-image:4

pipelines:
  branches:
    "**":
      - step:
          name: Upload to Ubuntu server
          script:
            - apt-get update && apt-get install -y openssh-client rsync

            # Load SSH key
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa

            # Trust server host key (preload to avoid verification errors)
            - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

            # Sanity check & ensure target dir exists
            - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "mkdir -p /var/www/new && echo Connected OK"

            # Deploy (preserve .env on server; exclude sensitive/dev files)
            - RSYNC_RSH="ssh -o StrictHostKeyChecking=no" rsync -avz --delete \
                --exclude='.env' \
                --exclude='.git' \
                --exclude='.gitignore' \
                --exclude='*.log' \
                --exclude='*.sql' \
                --exclude='*.zip' \
                --exclude='*.tar' \
                --exclude='*.gz' \
                --exclude='node_modules/' \
                --exclude='vendor/' \
                --exclude='storage/' \
                ./ $SERVER_USER@$SERVER_IP:/var/www/new
