image: atlassian/default-image:4

pipelines:
  branches:
    "**":
      - step:
          name: Upload to Ubuntu server
          script:
            - apt-get update && apt-get install -y openssh-client rsync

            #  Load SSH key
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa

            #  Test SSH connection (no host key writing)
            - ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $SERVER_USER@$SERVER_IP "echo Connected OK"

            #  Deployment command with exclusions
            - rsync -avz --delete \
                --exclude='.env' \
                --exclude='.git' \
                --exclude='.gitignore' \
                --exclude='*.log' \
                --exclude='*.sql' \
                --exclude='*.zip' \
                --exclude='*.tar' \
                --exclude='*.gz' \
                --exclude='node_modules/' \
                --exclude='vendor/' \
                --exclude='storage/' \
                -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" ./ $SERVER_USER@$SERVER_IP:/var/www/new
